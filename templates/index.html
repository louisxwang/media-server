<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Browser</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        header { background-color: #4a484d; color: white; padding: 5px; text-align: center; font-size: 1em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #searchBar {
            padding: 8px;
            margin: 5px;
            font-size: 16px;
            width: calc(70% - 20px);
        }
        .breadcrumb { background-color: rgb(36, 34, 34); padding: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); margin-bottom: 10px; }
        .breadcrumb a { margin-right: 5px; color: #c7bcd6; text-decoration: none; }
        .breadcrumb span { margin-right: 5px; }
        .gallery-container { padding: 4px; max-width: 100vw;  margin: auto; }
        .grid { display: grid; grid-gap: 1px; grid-template-columns: repeat(3, minmax(33%, 1fr));  grid-auto-flow: dense;}
        .grid-item { position: relative;  margin: 0px; }  /* Do no add display attribute to any of grid elements, should be controlled by filtering*/
        .grid-item img, .grid-item video { width: 33vw; height: 33vw; border-radius: 4px; object-fit: cover;}
        .grid-checkbox {width:10vw; height: 9vw; position: absolute; top: 0px; right:10px; display: none; opacity: 0.5; z-index: 1; }
        .small-checkbox {width:30px; height: 30px;}
        .directory-item { text-align:center; align-items: center; justify-content: center; align-self: center; width: 33vw; height: 50px; border-radius: 15px; background-color: rgb(210, 210, 0); font-size: 20px;}
        .media-item {text-align:center}
        .modal { display: none; position: fixed; z-index: 1; 
            left: 0; top: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.9);
            align-content: center;
        }
        .bottom-bar { display: block; position: fixed; z-index: 1; 
            left: 0; bottom: 0; width: 100%; height: 5%; 
            background-color: #4a484d;
            align-content: center;
        }
        .bottom-bar-btn { font-size: 16px;
        }
        .modal-media-container{
            position: absolute; z-index: 1; 
            left: 0; top: 0; width: 100%; height: 100%;
            align-content: center;
            overflow:scroll;
        }
        .modal img, .modal video { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            max-width: 100%;
            max-height: 100%;
        }
        @-webkit-keyframes zoom { from { -webkit-transform: scale(0) } to { -webkit-transform: scale(1) } }
        @keyframes zoom { from { transform: scale(0) } to { transform: scale(1) } }
        .close { position: absolute; bottom: 20vh; left: 0; padding: 5px; color: #f1f1f1; font-size: 20px; font-weight: bold; transition: 0.3s; z-index: 2;}
        /* .close:hover, .close:focus { color: #bbb; text-decoration: none; cursor: pointer; } */
        .full-screen-btn {
            position: absolute;
            bottom: 15px;
            right: 90px;
            color: #f1f1f1;
            font-size: 30px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
            z-index: 1; /* Ensure it's on top */
        }
        .full-screen-btn:hover, .full-screen-btn:focus {
            color: #bbb;
        }
        .prev, .next  {z-index: 1; cursor: pointer; position: absolute; width: 5vw; height: 5vw; 
            padding: 5px; margin-top: -50px; color: white; font-weight: bold; font-size: 20px; 
            transition: 0.6s ease; border-radius: 0 3px 3px 0; user-select: none; -webkit-user-select: none; }
        /*.next { right: 0; border-radius: 3px 0 0 3px; }*/
        .next { left: 0; border-radius: 3px 0 0 3px;  bottom:30vh; }
        .prev { left: 0; border-radius: 3px 0 0 3px; bottom:40vh; }
        /* .prev:hover, .next:hover { background-color: rgba(0, 0, 0, 0.2); } */
        .zoom-btn {
            position: absolute;
            bottom: 20px;
            right: 130px;
            color: #f1f1f1;
            font-size: 26px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
            z-index: 1;
        }
        /* Dropdown Menu Styles */
        .menu-btn {
            position: absolute;
            top: 12px;
            right: 80px;
            color: #f1f1f1;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            z-index: 2;
        }
        .modal-menu {
            display: none;
            position: absolute;
            right: 20px;
            top: 60px;
            background-color: #333;
            box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
            z-index: 2;
            border-radius: 4px;
        }
        .modal-menu a {
            color: white;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }
        .modal-menu a:hover {
            background-color: #575757;
        }
        #menuToggle {
            position: fixed;
            left: 20px;
            top: 15px;
            font-size: 24px;
            cursor: pointer;
            z-index: 1000;
        }

        .side-menu {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 999;
            top: 0;
            left: 0;
            background-color: #111;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
        }

        .side-menu ul {
            list-style-type: none;
            padding: 0;
        }

        .side-menu ul li {
            padding: 8px 8px 8px 32px;
            text-decoration: none;
            font-size: 25px;
            color: #818181;
            display: block;
            transition: 0.3s;
        }

        .side-menu ul li:hover {
            color: #f1f1f1;
        }

        .side-menu ul li a {
            color: #818181;
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        .side-menu ul li a i {
            margin-right: 10px;
        }
        .side-menu.open{
            width: 200px;
        }
        .main-section {
            position: relative;
            background: #E4E9F7;
            height: 100vh;
            left: 0px;
            width: calc(100% - 0px);
            transition: all 0.5s ease;
        }
        .side-menu.open ~ .main-section {
            left: 200px;
            width: calc(100% - 200px);
        }

        .tag-button {
            position: relative;
            display: inline-block;
            margin: 1px;
            padding: 10px 10px;
            background-color: #002c5c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .tag-modal-button{
            position: relative;
            display: inline-block;
            margin: 1px;
            padding: 10px 10px;
            background-color: #002c5c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .tag-button.selected {
            background-color: #0068d8;
        }
        .tag-modal-button.selected {
            background-color: #0068d8;
        }
        .tag-modal{position:fixed; top:10vh; left:50%; transform:translateX(-50%); 
            width: 80vw;
            max-height: 80vh;
            min-height: 20vh;
            color:white; 
            font-size:30px; font-weight:bold; z-index:2; display: none; 
            background-color: rgba(0, 0, 0, 0.1);
            align-content: center;
            overflow: scroll;
            z-index: 3;
        }
        .tag-modal-close { position: absolute; top: 0px; right: 0px; z-index: 999; 
            color: #f1f1f1; font-size: 40px; font-weight: bold; transition: 0.3s; z-index: 2;}
        #existingTags {
            display: flex;
            flex-wrap: wrap;
            /* justify-content: space-between; */
        }
        .tag-index{
            display: inline-block;
        }
        
    </style>
</head>
<body>
    <header>
        <i class="fas fa-bars" id="menuToggle" onclick="toggleSideMenu()"></i> <!-- Lateral menu button -->
        <!-- Media Browser -->
        <input type="text" id="searchBar" placeholder="Search media..." oninput="searchMedia(this)">
        <button onclick="searchMediaGlobal()">Global Search</button>
        <button onclick="toggleMediaCheckbox()">Multi Select</button>
        <!-- upper Right corner dropdown Menu Buttons ⋮ -->
    </header>
    <div id="sideMenu" onclick="foldSideMenu()" class="side-menu">
        <ul>
            <li><a href="/"><i class="fas fa-folder"></i> Folders</a></li>
            <li><a href="/all_media"><i class="fas fa-th-large"></i> All Medias</a></li>
            <li><a href="/all_videos"><i class="fas fa-video"></i> Videos</a></li>
            <li><a href="/clips"><i class="fas fa-film"></i> Clips</a></li>
            <li><a href="/tags"><i class="fas fa-tags"></i> Tags</a></li>
            <li><a href="/settings"><i class="fas fa-cog"></i> Settings</a></li>
        </ul>
    </div>
    <section id="mainSection" class="main-section">
        <div class="breadcrumb">
            <a href="{{ url_for(endpoint) }}">{{endpoint}}</a>
            {% for path in breadcrumb_paths %}
                <span>/</span>
                <a href="{{ url_for(endpoint, subpath='/'.join(breadcrumb_paths[:loop.index0+1])) }}">{{ path }}</a>
            {% endfor %}
        </div>
        {% if endpoint=="Tags" and breadcrumb_paths|length == 0 %}  <!-- Tag home page: tag list -->
            <div id="tagsHomePage">
                {% for tag, tag_pinyin in tags %}
                    <a href="{{ url_for(endpoint, subpath=subpath + '/' + tag) }}" class='tag-button' data-name="{{ tag }}" data-pinyin="{{ tag_pinyin }}" >
                        <input type="checkbox" class="grid-checkbox small-checkbox" data-name="{{ tag }}">
                        {{ tag }}
                    </a>
                {% endfor %}
            </div>
        {% endif %}
        <div class="gallery-container">
            <div class="grid">
                {% for directory in directories %}
                <a href="{{ url_for(endpoint, subpath=subpath + '/' + directory) }}" class="grid-item directory-item" data-name="{{ directory }}" >
                    <input type="checkbox" class="grid-checkbox small-checkbox" data-name="{{ '/'.join(breadcrumb_paths) + '/' + directory }}">
                    {{ directory }}
                </a>
                {% endfor %}
                {% for media in medias %}
                <div class="grid-item media-item" data-name="{{ media }}" >
                    <input type="checkbox" class="grid-checkbox" data-name="{{ media }}">
                    {% if media.endswith('.mp4') or media.endswith('.webm') %}
                    <!-- {{media}} -->
                    <video class="lazy" data-src="{{ previews[loop.index0] }}" data-full="{{ media }}" onclick="openModal(this, 'video');" muted loop autoplay></video>
                    {% else %}
                    <img src="{{ media }}" data-full="{{ media }}" onclick="openModal(this, 'image');" alt="Gallery media" loading="lazy">
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        <div id="mediaModal" class="modal">
            <div id="modalContentContainer" class="modal-media-container">
                <img id="img01" style="display:none;">
                <video id="video01" style="display:none;" controls autoplay loop></video>
            </div>
            <!-- <span class="full-screen-btn" id="fullscreen-btn" onclick="toggleFullScreen();">⛶</span> -->
            <span id="mediaName" onclick="renameMedia()" style="display:block; position:absolute; top:18px; left:50%; transform:translateX(-50%); width: 100vw-10px; color:white; font-size:16px; font-weight:bold; z-index:1;"></span>
            <a class="close" onclick="closeModal();">X</a>
            <!-- <span class="zoom-btn" id="zoom-btn" onclick="zoomIn()">+</span> -->
            <a class="prev" onclick="changeMedia(-1)">&lt;</a>  
            <a class="next" onclick="changeMedia(1)">></a>
            <!-- upper Right corner dropdown Menu Buttons ☰ -->
            <span class="menu-btn" onclick="toggleModalMenu()">⋮</span>
            <div class="modal-menu" id="modalMenu">
                <a onclick="deleteMedia()">Delete</a>
                <a id="clipButton" onclick="clipMedia()">Clip</a>
                <a id="tagButton" onclick="showTagModal()">Tag</a>
                <a id="hideNameButton" onclick="toggleMediaName()">Toggle Name</a>
                <a id="goto" onclick="goToLocation()">Go to folder</a>
            </div>
            <!-- Tags -->
            <span id="currentMediaTags" onclick="showTagModal()" style="position:absolute; bottom:50px; left:50%; transform:translateX(-50%); width: 100vw-10px; color:white; font-size:14px; font-weight:bold; z-index:1;"></span>
        </div>
        <div class="tag-modal" id="tagSelect">
            <input style="font-size: 20px" oninput="searchTagModal()" type="text" id="tagNameInput" placeholder="Type tag name here">
            <button style="font-size: 30px" onclick="createNewTag()">+</button>
            <button style="font-size: 30px" onclick="clearInput()">Clear</button>
            <button style="font-size: 30px" onclick="showOnlySelectedTagInModal()">Current</button>
            <button style="font-size: 30px" onclick="showLastUsedTagInModal()">Last used</button>
            <span style="position: sticky; top:0px; left:80%; font-size: 40px; font-weight: bold; z-index: 2;" onclick="closeTagModal()">X</span>
            <span style="position: sticky; top:0px; left:90%; font-size: 40px; font-weight: bold; z-index: 2" onclick="saveTags()">O</span>
            <div id="existingTags" class="d-flex flex-wrap" >
                {% for tag, tag_pinyin in tags %}
                <button class='tag-modal-button' data-name="{{ tag }}"  data-pinyin="{{ tag_pinyin }}" onclick="toggleSelected(this)" >
                    {{ tag }}
                </button>
                {% endfor %}
            </div>
        </div>
        <div class="bottom-bar" id="bottomBar">
            <button class="bottom-bar-btn" onclick="deleteSelected()"><i class="fas fa-trash"></i> Delete </button>
            <button class="bottom-bar-btn" onclick="renameSelected()"> Rename </button>
            <button class="bottom-bar-btn" onclick="toggleMediaCheckbox()">Select</button>
            <button class="bottom-bar-btn" onclick="cutSelected()">Cut</button>
            <button class="bottom-bar-btn" onclick="pasteSelected()">Paste</button>
            <button class="bottom-bar-btn" onclick="toggleTagModal()">Tag</button>
            {% if endpoint=="Tags" and breadcrumb_paths|length == 0 %}  <!-- Tag index page -->
            <button class="bottom-bar-btn" onclick="filterMediaWithTags('and')"> And </button>
            <button class="bottom-bar-btn" onclick="filterMediaWithTags('or')"> Or </button>
            <button class="bottom-bar-btn" onclick="filterMediaWithTags('hide')"> Hide </button>
            {% endif %}
        </div>
    </section>
    <script>
        var medias = {{ medias|tojson|safe }};
        // var previews = {{ previews|tojson|safe }};
        var endpoint = {{ endpoint|tojson|safe }};
        var media_tags = {{ media_tags|tojson|safe }};
        var subpath = {{subpath|tojson|safe}}
        var last_used_tags = {{last_used_tags|tojson|safe}}

        var currentIndex = -1;
        //for touch screen gestures
        var initialDistance = 0;
        var initialScale = 1;
        var initialX = 0;
        var initialY = 0;
        var isSwiping = false;

        const tagNameInput = document.getElementById('tagNameInput');
        const tagModal = document.getElementById('tagSelect')  //tag grid for selection
        var modalMenu = document.getElementById("modalMenu");

        function openModal(mediaElement, type) {
            // Pause all videos before opening the modal
            pauseAllVideos();
            var modal = document.getElementById('mediaModal');
            var modalImg = document.getElementById('img01');
            var modalVideo = document.getElementById('video01');
            var mediaName = document.getElementById('mediaName');
            var currentMediaTags = document.getElementById('currentMediaTags');
            var currentMedia = mediaElement.getAttribute('data-full');
            var currentMediaName = currentMedia.split('/').pop(); // Get the media file name
            // var fullScreenBtn = document.getElementById("fullscreen-btn")
            // var zoomBtn = document.getElementById("zoom-btn")

            mediaName.textContent = currentMediaName; // Set the media name
            currentIndex = medias.indexOf(currentMedia);
            currentMediaTags.textContent = media_tags[currentIndex]
            if (currentMediaTags.textContent == ''){
                currentMediaTags.textContent = '--'
            }
            console.log(currentIndex)

            modal.style.display = "block";
            if (type === 'image') {
                modalVideo.style.display = "none";
                modalImg.src = currentMedia;
                modalImg.style.display = "block";
                // fullScreenBtn.style.display = "block"
                // zoomBtn.style.display = "block"
            } else if (type === 'video') {
                modalImg.style.display = "none";
                modalVideo.src = currentMedia;
                modalVideo.style.display = "block";
                // fullScreenBtn.style.display = "none"
                // zoomBtn.style.display = "none"
            }

            document.getElementById('bottomBar').style.display='none';
        }

        function closeModal() {
            var modal = document.getElementById('mediaModal');
            modal.style.display = "none";
            var modalVideo = document.getElementById('video01');
            modalVideo.pause(); // Pause video on close
            if (document.fullscreenElement === modal) {
                document.exitFullscreen().catch(err => console.error(err));
            }
            lazyVideoLoad();
            closeTagModal();

            document.getElementById('bottomBar').style.display='block';
        }

        function changeMedia(step) {
            var gridItems = document.querySelectorAll('.grid-item.media-item');

            currentIndex += step;
            console.log(currentIndex)
            if (currentIndex >= medias.length) {
                currentIndex = 0;
            } else if (currentIndex < 0) {
                currentIndex = medias.length - 1;
            }
            // gridItems don't have the same len as medias
            while(gridItems[currentIndex].style.display=='none'){
                currentIndex += step<0 ? -1:1;
                if (currentIndex >= medias.length) {
                    currentIndex = 0;
                } else if (currentIndex < 0) {
                    currentIndex = medias.length - 1;
                }
            }

            var modalImg = document.getElementById('img01');
            var modalVideo = document.getElementById('video01');
            var mediaName = document.getElementById('mediaName');
            var currentMediaTags = document.getElementById('currentMediaTags');
            var fullScreenBtn = document.getElementById("fullscreen-btn")
            var zoomBtn = document.getElementById("zoom-btn")
            
            var currentMedia = medias[currentIndex];
            var currentMediaName = currentMedia.split('/').pop(); // Get the media file name
            mediaName.textContent = currentMediaName; // Set the media name
            currentMediaTags.textContent = media_tags[currentIndex]
            if (currentMediaTags.textContent == ''){
                currentMediaTags.textContent = '--'
            }
            toggleSelectedInTagModal();
            if (currentMedia.endsWith('.mp4') || currentMedia.endsWith('.webm')) {
                modalVideo.src = currentMedia;
                modalVideo.style.display = "block";
                modalImg.style.display = "none";
                // fullScreenBtn.style.display = "none"
                zoomBtn.style.display = "none"
                console.log(modalVideo.duration, video.hasAttribute("controls"));
                if(modalVideo.duration < 10 && video.hasAttribute("controls")) {
                    video.removeAttribute("controls")   
                } else if(modalVideo.duration > 10 && !video.hasAttribute("controls")) {
                    video.setAttribute("controls","controls")   
                }
            } else {
                modalImg.src = currentMedia;
                modalImg.style.display = "block";
                modalVideo.pause()
                modalVideo.style.display = "none";
                // fullScreenBtn.style.display = "block"
                zoomBtn.style.display = "block"
            }

            closeTagModal();
        }

        // Function to toggle full screen mode
        function toggleFullScreen() {
            var modalContentContainer = document.getElementById('mediaModal');
            var fullScreenBtn = document.getElementById('fullscreen-btn');
            if (!document.fullscreenElement) {
                if (modalContentContainer.requestFullscreen) {
                    modalContentContainer.requestFullscreen();
                } else if (modalContentContainer.mozRequestFullScreen) { // Firefox
                    modalContentContainer.mozRequestFullScreen();
                } else if (modalContentContainer.webkitRequestFullscreen) { // Chrome, Safari and Opera
                    modalContentContainer.webkitRequestFullscreen();
                } else if (modalContentContainer.msRequestFullscreen) { // IE/Edge
                    modalContentContainer.msRequestFullscreen();
                }
                fullScreenBtn.textContent = '>|<'; // Change icon for exiting full screen
            } else {
                if (document.exitFullscreen) {
                document.exitFullscreen();
                } else if (document.mozCancelFullScreen) { // Firefox
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) { // Chrome, Safari and Opera
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { // IE/Edge
                    document.msExitFullscreen();
                }
                fullScreenBtn.textContent = '⛶'; // Change icon for entering full screen
            }
        }

        document.addEventListener('fullscreenchange', function() {
            var fullScreenBtn = document.getElementById('fullscreen-btn');
            var galleryFullScreenBtn = document.querySelector('.gallery-fullscreen-btn');
            if (!document.fullscreenElement) {
                fullScreenBtn.textContent = '⛶';
            } else {
                fullScreenBtn.textContent = '⛶';
            }
        });

        function zoomIn() {
            var modalImg = document.getElementById('img01');
            var modalVideo = document.getElementById('video01');
            if (modalImg.style.display !== "none") {
                if (modalImg.style.scale === '2'){  //.width === "200vw"
                    modalImg.style.scale = '1';
                }
                else{
                    modalImg.style.scale = '2';
                }
            } 
            else if (modalVideo.style.display !== "none") {
                if (modalVideo.style.scale === '2'){  //.width === "200vw"
                    modalVideo.style.scale = '1';
                }
                else{
                    modalVideo.style.scale = '2';
                }
            }
        }

        function deleteMedia() {
            if (!confirm('Are you sure you want to delete this media?')) {
                return;
            }
            toggleModalMenu();
            var mediaSrc = medias[currentIndex];
            fetch('/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ path: mediaSrc }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    medias.splice(currentIndex, 1);
                    media_tags.splice(currentIndex, 1);
                    changeMedia(0);
                } else {
                    alert('Error deleting media: ' + data.error);
                }
            })
            .catch((error) => {
                console.error('Error:', error);
            });

            // Remove the deleted media from grid view
            var gridItems = document.querySelectorAll('.grid-item');
            gridItems[currentIndex].remove()
        }
        
        function searchMedia(searchInput) {
            // When displaying media grid page
            var searchWords = searchInput.value.toLowerCase().split(' ').filter(word => word);
            console.log(searchWords)
            var gridItems = document.querySelectorAll('.grid-item');
            gridItems.forEach(item => {
                var mediaName = item.getAttribute('data-name').toLowerCase().split('/').slice(-1)[0] ;
                mediaName = mediaName.split('.').slice(0, -1).join('.');
                var matches = searchWords.every(word => mediaName.includes(word));
                item.style.display = matches ? 'block' : 'none';
            });

            // When displaying tags page
            var tagItems = document.querySelectorAll('.tag-button');
            tagItems.forEach(item => {
                var tagName = item.getAttribute('data-name').toLowerCase();
                var tagPinyin = item.getAttribute('data-pinyin').toLowerCase();
                var matches = searchWords.every(word => tagName.includes(word) || tagPinyin.includes(word));
                item.style.display = matches ? 'inline-block' : 'none';
            });

        }

        function searchMediaGlobal() {
            // Search media in all subfolders
            searchInput = document.getElementById('searchBar');
            var searchWords = searchInput.value.toLowerCase().split(' ').filter(word => word);
            console.log(searchWords+subpath)
            if (subpath == '') {
                subpath = ' ';
            } // to avoid the url become //search_media//?keywords=, the extra space will be stripped in the backend
            url = encodeURI('/search_media/' +subpath + '?keywords=' + searchWords.join('_'));
            console.log(url);
            window.location.href=url;
        }

        function searchTagModal(){
            // Show only tags according to text in search input, hide other tags
            var searchWords = tagNameInput.value.toLowerCase().split(' ').filter(word => word);
            var tagItems = document.querySelectorAll('.tag-modal-button');
            tagItems.forEach(item => {
                var tagName = item.getAttribute('data-name').toLowerCase();
                var tagPinyin = item.getAttribute('data-pinyin').toLowerCase();
                var matches = searchWords.every(word => tagName.includes(word) || tagPinyin.includes(word));
                item.style.display = matches ? 'inline-block' : 'none';
            });

        }

        function showOnlySelectedTagInModal(){
            // Show only media current tags, hide other tags
            var tagItems = document.querySelectorAll('.tag-modal-button');
            tagItems.forEach(item => {
                var matches = item.classList.contains('selected');
                item.style.display = matches ? 'inline-block' : 'none';
            });

        }

        function showLastUsedTagInModal(){
            console.log(last_used_tags, typeof(last_used_tags))
            var tagItems = document.querySelectorAll('.tag-modal-button');
            tagItems.forEach(item => {
                var tagName = item.getAttribute('data-name');
                var matches = last_used_tags.includes(tagName);
                item.style.display = matches ? 'inline-block' : 'none';
            });
        }

        function refreshGrid() {
            // Code to re-render the grid if needed
            const gridContainer = document.querySelector('.grid');
            const gridItems = document.querySelectorAll('.grid-item');
            
            // Clear the grid
            gridContainer.innerHTML = '';

            // Re-add the remaining items
            gridItems.forEach(item => {
                gridContainer.appendChild(item);
            });
        }

        function renameMedia() {
            var mediaSrc = medias[currentIndex];
            var oldName = mediaSrc.split('/').pop();
            var extension = oldName.split('.').pop();
            var baseName = oldName.replace(/\.[^/.]+$/, "");
            var newName = prompt("Enter new name for the media (without extension):", baseName);
            if (newName && newName !== baseName) {
                fetch('/rename', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ path: mediaSrc, new_name: newName }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the media name in the UI
                        var oldMediaSrc = mediaSrc;
                        var newMediaSrc = oldMediaSrc.replace(/\/[^\/]+$/, '/' + newName + '.' + extension);
                        
                        medias[currentIndex] = newMediaSrc;
                        // medias_pinyin todo search media by pinyin
                        
                        var modalImg = document.getElementById('img01');
                        var modalVideo = document.getElementById('video01');
                        var mediaName = document.getElementById('mediaName');
                        
                        if (modalImg.style.display !== "none") {
                            modalImg.src = newMediaSrc;
                        } else if (modalVideo.style.display !== "none") {
                            modalVideo.src = newMediaSrc;
                        }
                        mediaName.textContent = newName + '.' + extension;

                        // alert('Media renamed successfully');
            } else {
                        alert('Error renaming media: ' + data.error);
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }
        }

        function lazyVideoLoad() {
            var lazyVideos = [].slice.call(document.querySelectorAll("video.lazy"));
            if ("IntersectionObserver" in window) {
                var lazyVideoObserver = new IntersectionObserver(function(entries, observer) {
                    entries.forEach(function(videoObserver) {
                        video = videoObserver.target;
                        if (videoObserver.isIntersecting) {
                            if(!video.src){
                                video.src = video.getAttribute('data-src');
                                video.load();
                            }
                            else if(video.paused){
                                video.play();
                            }
                            // video.target.classList.remove("lazy");
                            // lazyVideoObserver.unobserve(video.target);       
                        }
                        else{
                            video.pause();
                        }
                    });
                });

                lazyVideos.forEach(function(lazyVideo) {
                    lazyVideoObserver.observe(lazyVideo);
                });
            }
        }
        // check which video to start play at scroll and after page loading
        document.addEventListener("DOMContentLoaded", lazyVideoLoad);
        document.addEventListener("scroll", lazyVideoLoad);
        document.addEventListener("scroll", foldSideMenu);

        function pauseAllVideos() {
            var videos = document.querySelectorAll('.grid-item video');
            videos.forEach(video => {
                video.pause();
            });
        }

        function clipMedia(){
            var currentMedia = medias[currentIndex];
            if (currentMedia.endsWith('.mp4') || currentMedia.endsWith('.webm')) {
                window.location.href='/video_clip_marker?video=' + encodeURIComponent(currentMedia);
              }
        }

        function toggleSelected(elem){ //change the tag button color when it is clicked
            elem.classList.toggle('selected');
        }

        function toggleSelectedInTagModal(){  // pre-select all exisint tags in the tag selection menu
            const buttons = document.querySelectorAll('.tag-modal-button');
            buttons.forEach(button => {
                if (currentIndex !=-1 && media_tags[currentIndex].includes(button.getAttribute('data-name'))) {
                    button.classList.add('selected');
                }
                else {
                    button.classList.remove('selected');
                }
            })
        }

        function showTagModal(){
            //  used at media modal view to modifiy tags of a single media
            toggleSelectedInTagModal();
            tagModal.style.display = "block";
            modalMenu.style.display = "none";
        }
        function closeTagModal(){
            tagModal.style.display = "none";
        }

        function toggleTagModal(){
            // used at media grid view to add tags to selected medias
            if(tagModal.style.display == "block"){
                closeModal()
            }
            else{
                currentIndex = -1
                showTagModal()
            }
        }

        function createNewTag(){
            new_tag = tagNameInput.value.trim()
            new_tag_pinyin = 'abcdefghijklmnopqrstuvwxyz'
            new_tag_button =  document.createElement("button");
            new_tag_button.setAttribute('class', 'tag-modal-button')
            new_tag_button.setAttribute('data-name', new_tag)
            new_tag_button.setAttribute('data-pinyin', new_tag_pinyin)
            new_tag_button.onClick = toggleSelected(new_tag_button)
            new_tag_button.innerHTML=new_tag
            tagModalButtons = document.getElementById('existingTags')
            tagModalButtons.appendChild(new_tag_button)
            saveTags(new_tag);
        }
        function clearInput(){
            tagNameInput.value = '';
            tagNameInput.focus();
            searchTagModal(tagNameInput);
        }
        function get_selected_tags(){
            // Get all selected buttons in tag selcection pop up window
            var selectedTags = [];
            const buttons = document.querySelectorAll('.tag-modal-button.selected');
            buttons.forEach(button => {
                tag_name = button.getAttribute('data-name')
                selectedTags.push(tag_name);
                if (currentIndex == -1  || ! media_tags[currentIndex].includes(tag_name)){
                    if (! last_used_tags.includes(tag_name)){
                        last_used_tags.push(tag_name)
                        if (last_used_tags.length>10){
                            last_used_tags.shift()
                        }
                    }
                } 
            });
            // if(create_new_tag != ''){
                //     selectedTags.push(create_new_tag)
                // }
            return selectedTags
        }

        function saveTags(create_new_tag=''){
            // request server to apply tag change to currently displayed media
            var selectedTags = get_selected_tags()
            var mediaModal = document.getElementById('mediaModal')
            var currentMediaTags = document.getElementById('currentMediaTags');
            var currentMedia = ''
            if(mediaModal.style.display == "none"){
                // in grid view, add tag to selected medias, multiple items may be selected
                // only add tag is possible for now, remove tag is not possible
                var selectedGridItems = document.querySelectorAll('.grid-checkbox:checked');
                var selectedMediaNames = Array.from(selectedGridItems).map(item => item.dataset.name);
                currentMedia = selectedMediaNames  // selectedMediaNames is populated at toggleTagModal()

                //update displayed tag in page to avoid need of refreshing page
                selectedMediaNames.forEach(media => {
                    currentIndex = medias.indexOf(media);
                    media_tags[currentIndex] = media_tags[currentIndex].concat(selectedTags)
                    currentMediaTags.textContent = media_tags[currentIndex];
            }   );
            }
            else{
                // for the current displayed media
                media_tags[currentIndex] = selectedTags;  // update displayed tags in page without refreshing
                
                currentMediaTags.textContent = media_tags[currentIndex];
                currentMedia = medias[currentIndex];
            }

            console.log(currentMedia, selectedTags);
            // Send clips data to the server
            fetch('/save_tags', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                            media: currentMedia,
                            tags: selectedTags
                        })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to add to tag.');
                }
            })
            .catch(error => {
                console.error(error);
            });

            if(create_new_tag == ''){
                closeTagModal();
            }
        }

        function toggleMediaName() {
            var nameText = document.getElementById('mediaName');
            if (nameText.style.display === "block") {
                nameText.style.display = "none";
            } else {
                nameText.style.display = "block";
            }
        }

        function goToLocation(){
            var currentMedia = medias[currentIndex];
            window.location.href= '/browse/' + currentMedia.split('/').slice(2,-1).join('/')
        }

        function toggleModalMenu() {
            var modalMenu = document.getElementById("modalMenu");
            if (modalMenu.style.display === "block") {
                modalMenu.style.display = "none";
            } else {
                modalMenu.style.display = "block";
            }
            var clipButton = document.getElementById("clipButton")
            var currentMedia = medias[currentIndex];
            if (currentMedia.endsWith('.mp4') || currentMedia.endsWith('.webm')) {
                clipButton.style.display = "block"
              }
              else{
                clipButton.style.display = "none"
              }
        }

        var sideMenu = document.getElementById('sideMenu');
        var mainSection = document.getElementById('mainSection');
        function toggleSideMenu() {
            sideMenu.classList.toggle("open");
        }

        function foldSideMenu(){
            sideMenu.classList.remove("open");
        }

        function toggleMediaCheckbox(){
            // Click: show checkboxes for each media, a 2nd click: select all medias, a 3rd click: hide checkboxes
            const checkboxElements = document.querySelectorAll('.grid-checkbox');
            const selectedItems = document.querySelectorAll('.grid-checkbox:checked');
            if (checkboxElements[0].style.display!='block'){
                checkboxElements.forEach(item => {
                item.style.display = 'block';
            });
            }
            else if (checkboxElements.length != selectedItems.length) {
                checkboxElements.forEach(item => {
                item.checked = true;
            });
            }
            else {
                checkboxElements.forEach(item => {
                item.checked = false;
                item.style.display = 'none';
            });
            }
        }

        function deleteSelected() {
            const selectedItems = document.querySelectorAll('.grid-checkbox:checked');
            const selectedNames = Array.from(selectedItems).map(item => item.dataset.name);

            if (selectedNames.length > 0) {
                if (!confirm('Are you sure you want to delete this media?')) {
                    return;
                }
                // Send selectedNames to the server for deletion
                fetch('/delete_multiple', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        items: selectedNames,
                        endpoint: endpoint,
                     }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the deleted items from the DOM
                        selectedItems.forEach(item => item.closest('.grid-item').remove());
                        //Remove media_tags element
                        selectedNames.forEach(item => {
                            idx = medias.indexOf(item);
                            medias.splice(idx, 1);
                            media_tags.splice(idx, 1);
                        });     
                    } else {
                        alert('Failed to delete selected items');
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            } else {
                alert('No items selected');
            }
        }

        function renameSelected() {
            //rename selected tags or folder/medias, multiple items may be selected
            const selectedItems = document.querySelectorAll('.grid-checkbox:checked');
            const selectedNames = Array.from(selectedItems).map(item => item.dataset.name);
            if (selectedNames.length > 0) {
                var newName = prompt("Enter new name (with extension if there is), use # as original name placeholder", "");
                if (!confirm('Are you sure you want to rename?')) {
                    return;
                }
                // Send selectedNames to the server for deletion
                fetch('/rename_multiple', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        items: selectedNames,
                        endpoint: endpoint,
                        new_name: newName,
                     }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Refresh the page
                        location.reload();
                    } else {
                        alert('Failed to rename selected items');
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            } else {
                alert('No items selected');
            }
        }

        function cutSelected() {
            const selectedItems = document.querySelectorAll('.grid-checkbox:checked');
            const selectedNames = Array.from(selectedItems).map(item => item.dataset.name);

            if (selectedNames.length > 0) {
                // Send selectedNames to the server for deletion
                fetch('/cut_multiple', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        items: selectedNames,
                        endpoint: endpoint,
                     }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        pass  
                    } else {
                        alert('Failed to cut selected items');
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            } else {
                alert('No items selected');
            }
        }

        function pasteSelected() {
            // Send selectedNames to the server for deletion
            fetch('/paste_multiple', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    destination: subpath,
                    endpoint: endpoint,
                    }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Refresh the page
                    location.reload();
                } else {
                    alert('Failed to paste selected items');
                }
            })
            .catch((error) => {
                console.error('Error:', error);
            });

        }

        function filterMediaWithTags(operation) {
            // operation: string, ['and', 'or', 'hide']
            //'and': show medias with all selected tags
            //'or': show medias with any selected tags
            //'hide': hide selected medias from gallery, they can be find in Hidden Medias menu (WIP)

            //get all selected tags
            const selectedItems = document.querySelectorAll('.grid-checkbox:checked');
            const selectedNames = Array.from(selectedItems).map(item => item.dataset.name);

            if (selectedNames.length > 0) {
                console.log(selectedNames)
                url = encodeURI('/filter_media_with_tags?op=' + operation + '&tags=' + selectedNames.join('_'));
                console.log(url);
                window.location.href=url;
            } else {
                alert('No items selected');
            }
        }

    </script>
</body>
</html>
